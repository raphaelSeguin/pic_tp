---
- hosts: slave
  become: true
  remote_user: vagrant
  tasks:
  - name: cree repertoire
    file:
      path: ./prod_image
      state: directory
      mode: '0755'
  - name: cree fichier Dockerfile
    file:
      path: ./prod_image/Dockerfile
      state: touch
      mode: '0644'
  - name: couper le poulet
    copy:
      src: /home/vagrant/.m2/repository/com/gtm/devops/1.0/devops-1.0.war
      dest: ./prod_image/
  - name: ecrit Dockerfile
    blockinfile:
      path: ./prod_image/Dockerfile
      block: |
        FROM raphaelseguin/maven-git:latest
        COPY ./devops-1.0.war .
        EXPOSE 80
        ENTRYPOINT ['java']
        CMD ['-jar','devops-1.0.war']
  - name: install python docker lib
    pip:
      name: docker
      state: latest
  - name: build image docker
    docker_image:
      build: 
        path: ./prod_image
      name: raphaelseguin/devopsapp
      source: build
      pull: yes   
      tag: v1 

#  - name: Log into DockerHub
#    docker_login:
#      username: raphaelseguin
#      password: dockerraph2020

#  - name: push to docker hub
#    docker_image:
#      name: raphaelseguin/devopsapp
#      repository: raphaelseguin/devopsapp
#      tag: v1
#      push: yes
#      source: local
  - name: Login docker shell
    shell:
      cmd: sudo docker login --username=raphaelseguin --password=dockerraph2020
  - name: Shell
    shell:
      cmd: sudo docker push raphaelseguin/devopsapp:v1

- hosts: prod
  become: yes
  remote_user: vagrant
  tasks:
  - name: pull container
    docker_image:
      name: raphaelseguin/devopsapp:v1
      source: pull    
  - name: run container
    docker_container:
      name: raphaelseguin/devopsapp:v1
      port: "80:80"
